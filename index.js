const { Client } = require('discord.js-selfbot-v13');

const client = new Client();
require("./server");

// ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
const weightedChannelIds = [
  { id: '1080187563073081454', weight: 100 },
  { id: '1377142261363638363', weight: 0 },
];

// ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö log ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
const forwardChannelId = '1401622760496562269';
const logChannelId = '1401627069393272912';

// ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
const keywords = ['<@&1082277102830764152>'];

const mentionMessages = ['<@&1082277102830764152> ‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß'];


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function getRandomMentionMessage() {
  const index = Math.floor(Math.random() * mentionMessages.length);
  return mentionMessages[index];
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
function getRandomChannelId() {
  const totalWeight = weightedChannelIds.reduce((sum, ch) => sum + ch.weight, 0);
  const random = Math.random() * totalWeight;
  let cumulative = 0;

  for (const channel of weightedChannelIds) {
    cumulative += channel.weight;
    if (random < cumulative) {
      return channel.id;
    }
  }
}

client.on('ready', async () => {
  console.log(`‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ${client.user.tag}`);

  async function sendRandomMessage() {
    const targetChannelId = getRandomChannelId();

    try {
      const channel = await client.channels.fetch(targetChannelId);
      const logChannel = await client.channels.fetch(logChannelId);

      if (!channel) {
        console.log(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á ${targetChannelId}`);
        return;
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô (limit=1)
      const messages = await channel.messages.fetch({ limit: 1 });
      const lastMessage = messages.first();

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡πà‡∏á
      if (lastMessage && lastMessage.author.id === client.user.id) {
        console.log(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ${targetChannelId} ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÄ‡∏≠‡∏á, ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥`);
      } else {
        const messageToSend = getRandomMentionMessage();
        await channel.send(messageToSend);
        console.log(`‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á ${targetChannelId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);

        if (logChannel) {
          await logChannel.send(`[ LOG ] ‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á <#${targetChannelId}>`);
        }
      }
    } catch (error) {
      console.error(`‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á ${targetChannelId}:`, error);
    }

    const randMinutes = (minM, maxM) =>
  Math.floor(Math.random() * ((maxM - minM) * 60_000 + 1)) + minM * 60_000;

const delay = randMinutes(5, 10); // ms

    setTimeout(sendRandomMessage, delay);
  }
  sendRandomMessage();
});

client.on('messageCreate', async (message) => {
  if (message.author.id === client.user.id) return;

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á !test ‡∏à‡∏≤‡∏Å user ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
  if (message.author.id === '849964668177088562' && message.content.trim() === '!test') {
    try {
      await message.channel.send('‡∏ö‡∏≠‡∏ó‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö');
      console.log(`‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á !test ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${message.author.tag}`);
    } catch (error) {
      console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á !test:', error);
    }
    return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠
  }

  if (!weightedChannelIds.some(ch => ch.id === message.channel.id)) return;

  const content = message.content.toLowerCase();
  if (keywords.some(word => content.includes(word))) {
    console.log(`üì© ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: [${message.author.tag}] ${message.content}`);

    try {
      const forwardChannel = await client.channels.fetch(forwardChannelId);
      if (forwardChannel) {
        const cleaned = message.content.replace(/<@&1082277102830764152>/g, '').trim();
const messageLink = `https://discord.com/channels/${message.guild.id}/${message.channel.id}/${message.id}`;
await forwardChannel.send(`<@${message.author.id}> : ${cleaned}\n${messageLink}`);
        console.log('‚úÖ ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } else {
        console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á');
      }
    } catch (error) {
      console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:', error);
    }
  }
});

client.login(process.env.token);
